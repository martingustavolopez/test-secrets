name: üîµ Deploy to STAGING

on:
  push:
    branches:
      - 'staging'
      - 'release/*'
    paths-ignore:
      - '**.md'
      - 'docs/**'

  workflow_dispatch:

env:
  ENVIRONMENT: staging
  CONTAINER_NAME: secrets-demo-staging
  IMAGE_NAME: secrets-demo
  PORT: 3002

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest  # Usar tu runner: ltrodckrapqa01
    environment: staging  # ‚≠ê Environment diferente = Secrets diferentes

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üõë Stop and remove existing container
        run: |
          echo "üîç Buscando contenedores existentes..."
          if [ "$(docker ps -aq -f name=${{ env.CONTAINER_NAME }})" ]; then
            echo "üóëÔ∏è Eliminando contenedor existente: ${{ env.CONTAINER_NAME }}"
            docker rm -f ${{ env.CONTAINER_NAME }}
          else
            echo "‚úÖ No hay contenedores previos"
          fi
        continue-on-error: true

      - name: üßπ Remove old images
        run: |
          echo "üîç Buscando im√°genes antiguas..."
          if [ "$(docker images -q ${{ env.IMAGE_NAME }}:staging)" ]; then
            echo "üóëÔ∏è Eliminando imagen antigua"
            docker rmi -f ${{ env.IMAGE_NAME }}:staging || true
          fi
        continue-on-error: true

      - name: üê≥ Build Docker image
        run: |
          echo "üì¶ Building Docker image for STAGING..."
          docker build \
            -t ${{ env.IMAGE_NAME }}:staging \
            .
          echo "‚úÖ Image built successfully"

      - name: üöÄ Deploy container with secrets
        run: |
          echo "üöÄ Desplegando contenedor en STAGING..."

          # ‚≠ê Secrets espec√≠ficos del environment 'staging'
          # Configurados en: Settings > Environments > staging > Secrets

          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            -p ${{ env.PORT }}:3000 \
            --cpus="0.5" \
            --memory="512m" \
            --restart unless-stopped \
            -e ENVIRONMENT=${{ env.ENVIRONMENT }} \
            -e PORT=3000 \
            -e API_KEY="${{ secrets.API_KEY }}" \
            -e DB_HOST="${{ secrets.DB_HOST }}" \
            -e DB_USER="${{ secrets.DB_USER }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e EXTERNAL_API_URL="${{ secrets.EXTERNAL_API_URL }}" \
            -e EXTERNAL_API_TOKEN="${{ secrets.EXTERNAL_API_TOKEN }}" \
            -e FEATURE_FLAG_PREMIUM="${{ secrets.FEATURE_FLAG_PREMIUM }}" \
            ${{ env.IMAGE_NAME }}:staging

          echo "‚úÖ Container deployed successfully"

      - name: üè• Health check
        run: |
          echo "‚è≥ Esperando que el contenedor est√© listo..."
          sleep 5

          for i in {1..10}; do
            if docker exec ${{ env.CONTAINER_NAME }} node -e "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"; then
              echo "‚úÖ Health check passed!"
              docker logs ${{ env.CONTAINER_NAME }} --tail 20
              exit 0
            fi
            echo "‚è≥ Intento $i/10 - Esperando..."
            sleep 3
          done

          echo "‚ùå Health check failed"
          docker logs ${{ env.CONTAINER_NAME }}
          exit 1

      - name: üìä Show deployment info
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT SUCCESSFUL - STAGING"
          echo "=========================================="
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Container: ${{ env.CONTAINER_NAME }}"
          echo "Port: ${{ env.PORT }}"
          echo "Image: ${{ env.IMAGE_NAME }}:staging"
          echo "=========================================="
          echo "üîó Access the app at: http://localhost:${{ env.PORT }}"
          echo "üîç Health check: http://localhost:${{ env.PORT }}/health"
          echo "‚öôÔ∏è  Config: http://localhost:${{ env.PORT }}/config"
          echo "=========================================="
          echo "üìã Secrets loaded from GitHub Environment 'staging':"
          echo "  - API_KEY: ${{ secrets.API_KEY != '' && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - DB_HOST: ${{ secrets.DB_HOST != '' && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - DB_USER: ${{ secrets.DB_USER != '' && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - DB_PASSWORD: ${{ secrets.DB_PASSWORD != '' && '‚úÖ Set (hidden)' || '‚ùå Not set' }}"
          echo "  - EXTERNAL_API_URL: ${{ secrets.EXTERNAL_API_URL != '' && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - EXTERNAL_API_TOKEN: ${{ secrets.EXTERNAL_API_TOKEN != '' && '‚úÖ Set (hidden)' || '‚ùå Not set' }}"
          echo "  - FEATURE_FLAG_PREMIUM: ${{ secrets.FEATURE_FLAG_PREMIUM }}"
          echo "=========================================="

      - name: üìß Notify success
        if: success()
        run: |
          echo "‚úÖ Pipeline completed successfully for STAGING"
          echo "Workflow: ${GITHUB_WORKFLOW}"
          echo "Repository: ${GITHUB_REPOSITORY}"
          echo "Run number: ${GITHUB_RUN_NUMBER}"
          echo "Run URL: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

      - name: üìß Notify failure
        if: failure()
        run: |
          echo "‚ùå Pipeline failed for STAGING"
          echo "Workflow: ${GITHUB_WORKFLOW}"
          echo "Repository: ${GITHUB_REPOSITORY}"
          echo "Run URL: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

  cleanup-workspace:
    name: Cleanup Workspace
    needs: [deploy]
    if: always()  # Se ejecuta siempre, sin importar si deploy tuvo √©xito o fall√≥
    runs-on: ubuntu-latest  # Usar tu runner: ltrodckrapqa01

    steps:
      - name: üßπ Limpiar workspace
        run: |
          echo "üßπ Limpiando workspace..."

          # Limpiar archivos de Git
          if [ -d "${{ github.workspace }}" ]; then
            cd "${{ github.workspace }}"
            git clean -ffdx || echo "‚ö†Ô∏è  Git clean fall√≥ (puede no existir repo)"
            git reset --hard || echo "‚ö†Ô∏è  Git reset fall√≥"
          fi

          # Limpiar todo el workspace
          rm -rf "${{ github.workspace }}" || echo "‚ö†Ô∏è  No se pudo eliminar workspace"

          echo "‚úÖ Workspace limpiado"

      - name: üóëÔ∏è Limpiar im√°genes Docker dangling (opcional)
        run: |
          echo "üóëÔ∏è Limpiando im√°genes dangling..."
          docker image prune -f || echo "‚ö†Ô∏è  Docker prune fall√≥"
          echo "‚úÖ Im√°genes dangling eliminadas"
        continue-on-error: true
