name: üü¢ Deploy to PRODUCTION

on:
  push:
    branches:
      - 'main'
      - 'master'
    paths-ignore:
      - '**.md'
      - 'docs/**'

  workflow_dispatch:

env:
  ENVIRONMENT: prod
  CONTAINER_NAME: secrets-demo-prod
  IMAGE_NAME: secrets-demo
  PORT: 3000

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest  # Usar tu runner de producci√≥n
    environment:
      name: production  # ‚≠ê Environment de producci√≥n con sus secrets espec√≠ficos
      url: http://localhost:3000  # URL opcional para acceso r√°pido

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üõë Stop and remove existing container
        run: |
          echo "üîç Buscando contenedores existentes..."
          if [ "$(docker ps -aq -f name=${{ env.CONTAINER_NAME }})" ]; then
            echo "üóëÔ∏è Eliminando contenedor existente: ${{ env.CONTAINER_NAME }}"
            docker rm -f ${{ env.CONTAINER_NAME }}
          else
            echo "‚úÖ No hay contenedores previos"
          fi
        continue-on-error: true

      - name: üßπ Remove old images (keep last 2)
        run: |
          echo "üîç Limpiando im√°genes antiguas (manteniendo √∫ltimas 2)..."
          docker images ${{ env.IMAGE_NAME }} --format "{{.ID}}" | tail -n +3 | xargs -r docker rmi -f || true
        continue-on-error: true

      - name: üê≥ Build Docker image
        run: |
          echo "üì¶ Building Docker image for PRODUCTION..."
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

          docker build \
            -t ${{ env.IMAGE_NAME }}:prod \
            -t ${{ env.IMAGE_NAME }}:prod-${{ github.sha }} \
            --label "build.date=${BUILD_DATE}" \
            --label "git.commit=${{ github.sha }}" \
            --label "git.branch=${GITHUB_REF##*/}" \
            .

          echo "‚úÖ Image built successfully"
          docker images ${{ env.IMAGE_NAME }}

      - name: üöÄ Deploy container with secrets
        run: |
          echo "üöÄ Desplegando contenedor en PRODUCTION..."

          # ‚≠ê PRODUCCI√ìN: Secrets configurados en environment 'production'
          # Settings > Environments > production > Secrets
          # Estos secrets pueden tener protecci√≥n adicional (required reviewers, etc.)

          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            -p ${{ env.PORT }}:3000 \
            --cpus="1.0" \
            --memory="1g" \
            --restart unless-stopped \
            -e ENVIRONMENT=${{ env.ENVIRONMENT }} \
            -e PORT=3000 \
            -e API_KEY="${{ secrets.API_KEY }}" \
            -e DB_HOST="${{ secrets.DB_HOST }}" \
            -e DB_USER="${{ secrets.DB_USER }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e EXTERNAL_API_URL="${{ secrets.EXTERNAL_API_URL }}" \
            -e EXTERNAL_API_TOKEN="${{ secrets.EXTERNAL_API_TOKEN }}" \
            -e FEATURE_FLAG_PREMIUM="${{ secrets.FEATURE_FLAG_PREMIUM }}" \
            ${{ env.IMAGE_NAME }}:prod

          echo "‚úÖ Container deployed successfully"

      - name: üè• Health check
        run: |
          echo "‚è≥ Esperando que el contenedor est√© listo..."
          sleep 5

          for i in {1..15}; do
            if docker exec ${{ env.CONTAINER_NAME }} node -e "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"; then
              echo "‚úÖ Health check passed!"
              docker logs ${{ env.CONTAINER_NAME }} --tail 20
              exit 0
            fi
            echo "‚è≥ Intento $i/15 - Esperando..."
            sleep 3
          done

          echo "‚ùå Health check failed"
          docker logs ${{ env.CONTAINER_NAME }}
          exit 1

      - name: üìä Show deployment info
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT SUCCESSFUL - PRODUCTION"
          echo "=========================================="
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Container: ${{ env.CONTAINER_NAME }}"
          echo "Port: ${{ env.PORT }}"
          echo "Image: ${{ env.IMAGE_NAME }}:prod"
          echo "Git Commit: ${{ github.sha }}"
          echo "=========================================="
          echo "üîó Access the app at: http://localhost:${{ env.PORT }}"
          echo "üîç Health check: http://localhost:${{ env.PORT }}/health"
          echo "‚öôÔ∏è  Config: http://localhost:${{ env.PORT }}/config"
          echo "=========================================="
          echo "üìã Secrets loaded from GitHub Environment 'production':"
          echo "  - API_KEY: ${{ secrets.API_KEY != '' && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - DB_HOST: ${{ secrets.DB_HOST != '' && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - DB_USER: ${{ secrets.DB_USER != '' && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - DB_PASSWORD: ${{ secrets.DB_PASSWORD != '' && '‚úÖ Set (hidden)' || '‚ùå Not set' }}"
          echo "  - EXTERNAL_API_URL: ${{ secrets.EXTERNAL_API_URL != '' && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - EXTERNAL_API_TOKEN: ${{ secrets.EXTERNAL_API_TOKEN != '' && '‚úÖ Set (hidden)' || '‚ùå Not set' }}"
          echo "  - FEATURE_FLAG_PREMIUM: ${{ secrets.FEATURE_FLAG_PREMIUM }}"
          echo "=========================================="
          echo "üìà Container stats:"
          docker stats ${{ env.CONTAINER_NAME }} --no-stream

      - name: üìß Notify success
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ PRODUCTION DEPLOYMENT COMPLETED"
          echo "=========================================="
          echo "Workflow: ${GITHUB_WORKFLOW}"
          echo "Repository: ${GITHUB_REPOSITORY}"
          echo "Run number: ${GITHUB_RUN_NUMBER}"
          echo "Run URL: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          echo "Deployed commit: ${{ github.sha }}"
          echo "=========================================="

      - name: üìß Notify failure
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå PRODUCTION DEPLOYMENT FAILED"
          echo "=========================================="
          echo "Workflow: ${GITHUB_WORKFLOW}"
          echo "Repository: ${GITHUB_REPOSITORY}"
          echo "Run URL: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          echo "=========================================="
          echo "‚ö†Ô∏è  CRITICAL: Production deployment failed!"
          echo "Please check logs and take immediate action."
          echo "=========================================="

  cleanup-workspace:
    name: Cleanup Workspace
    needs: [deploy]
    if: always()  # Se ejecuta siempre, sin importar si deploy tuvo √©xito o fall√≥
    runs-on: ubuntu-latest  # Usar tu runner de producci√≥n

    steps:
      - name: üßπ Limpiar workspace
        run: |
          echo "üßπ Limpiando workspace..."

          # Limpiar archivos de Git
          if [ -d "${{ github.workspace }}" ]; then
            cd "${{ github.workspace }}"
            git clean -ffdx || echo "‚ö†Ô∏è  Git clean fall√≥ (puede no existir repo)"
            git reset --hard || echo "‚ö†Ô∏è  Git reset fall√≥"
          fi

          # Limpiar todo el workspace
          rm -rf "${{ github.workspace }}" || echo "‚ö†Ô∏è  No se pudo eliminar workspace"

          echo "‚úÖ Workspace limpiado"

      - name: üóëÔ∏è Limpiar im√°genes Docker dangling (opcional)
        run: |
          echo "üóëÔ∏è Limpiando im√°genes dangling..."
          docker image prune -f || echo "‚ö†Ô∏è  Docker prune fall√≥"
          echo "‚úÖ Im√°genes dangling eliminadas"
        continue-on-error: true
